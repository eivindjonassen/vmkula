# Implementation Plan: API-Football Data Refactor

**Branch**: main  
**Date**: 2025-12-27  
**Spec**: [spec.md](./spec.md)  
**Research**: [research.md](./research.md)  
**Approach**: **Option A+ (Enhanced)** - Legacy cleanup + API-Football canonical source with audit trail

---

## Planning Strategy

### Scope Assessment

- **Codebase Size**: Small (<20 files) - 10 Python source files in backend/src
- **Research Scope**: Medium - Required investigation of current hybrid architecture
- **Agent Assistance**: Yes - Used @general agent for systematic codebase exploration

### Agreed Approach: Option A+ (Enhanced)

**What we're doing**:

1. **Clean up legacy code** (Original Option A)
   - Delete migration scripts (migrate_to_firestore.py)
   - Remove old DBManager references
   - Clean up documentation

2. **Add API-Football as canonical source** (Enhancement)
   - Create new `api_football_raw` Firestore collection
   - Store raw API responses with timestamps (audit trail)
   - Implement sync process with change detection
   - Handle conflicts between manual edits and API updates

**New Architecture**:
```
API-Football v3 (Source of Truth)
     â†“
api_football_raw collection (Audit trail, timestamped)
     â†“
Sync Process (Change detection & conflict resolution)
     â†“
teams/matches collections (Your internal structure)
     â†“
Existing prediction pipeline (No changes needed)
```

**Key Benefits**:
- ğŸ¯ API-Football data preserved in raw form (audit trail)
- ğŸ”„ Change detection (know when teams/fixtures update)
- âš”ï¸ Conflict resolution (manual overrides vs API updates)
- ğŸ“Š Traceability (can replay syncs or rollback)
- âœ… Low risk (additive, doesn't break existing flow)

---

## Technical Context

- **Language/Framework**: Python 3.11+ (backend), TypeScript 5.8+ (frontend)
- **Primary Dependencies**: 
  - Backend: FastAPI, Firebase Admin SDK, Google Generative AI, requests
  - Frontend: Next.js 15+, Firestore client SDK
- **Storage**: Firestore (primary + new api_football_raw collection)
- **Testing**: Pytest + pytest-cov (backend), Vitest + React Testing Library (frontend)
- **Project Type**: Monorepo (backend/ + frontend/ + shared specs/)

---

## Constitution Check

Based on `RULES.md` review, this refactor must comply with:

- **Rule 1 (Test-Driven Development)**: Will write failing tests FIRST before implementing sync logic. Test files to create: `test_api_football_sync.py`. Approach: Red-Green-Refactor cycle for new sync module.

- **Rule 2 (Code Style Guidelines)**: Existing code follows Black formatting and mypy typing. Backend uses snake_case, type hints, Black formatter (line length 88). All new code will maintain existing style.

- **Rule 3 (API-Football Rate Limiting)**: Preserved in current `data_aggregator.py` (0.5s delay, exponential backoff). RULES.md requirement: 0.5s between requests, max 3 retries (1s, 2s, 4s). Sync process will reuse existing rate limiting from DataAggregator.

- **Rule 4 (Firestore Schema Backward Compatibility)**: Frontend expects snake_case fields (`frontend/lib/firestore.ts:138-146`). Must preserve: `match_number`, `home_team_id`, `ai_summary`, `updated_at`. New `api_football_raw` collection is backend-only (no frontend impact). Existing `teams`/`matches` collections remain unchanged.

- **Rule 5 (Manual Triggers Only)**: FR-004 requires manual triggers for data synchronization. Will create new endpoint: `POST /api/sync-api-football`. No automatic/scheduled syncing (per spec requirements).

**Constitution Compliance**: âœ… All rules satisfied, no violations detected.

---

## Project Structure

**Structure Decision**: Monorepo with separate backend/frontend directories.

```
backend/
  src/
    â”œâ”€â”€ api_football_sync.py        # NEW - Sync logic with change detection
    â”œâ”€â”€ data_aggregator.py          # EXISTING - API-Football client (reuse)
    â”œâ”€â”€ firestore_manager.py        # MODIFY - Add api_football_raw methods
    â”œâ”€â”€ main.py                     # MODIFY - Add sync endpoint, cleanup comments
    â””â”€â”€ ...
  tests/
    â”œâ”€â”€ test_api_football_sync.py   # NEW - Sync logic tests
    â”œâ”€â”€ test_firestore_manager.py   # MODIFY - Add raw collection tests
    â””â”€â”€ ...
  migrate_to_firestore.py           # DELETE - Legacy migration script
  populate_from_api_football.py     # KEEP - Update to use new sync module
  test_norway_integration.py        # DELETE or FIX - Broken DBManager import
frontend/
  lib/
    â”œâ”€â”€ firestore.ts                # NO CHANGES - Verify compatibility
    â””â”€â”€ ...
```

---

## Phase 0: ACE-Enhanced Research & Exploration

**Status**: âœ… COMPLETE (research.md generated by @general agent)

### Key Findings

1. **SQLite Already Eliminated**: Main application uses only Firestore
2. **Current Architecture**: API-Football â†’ Local cache â†’ Firestore cache â†’ Predictions
3. **Legacy Code Identified**: Migration scripts reference non-existent `db_manager.py`
4. **Frontend Compatibility**: Snake_case Firestore schema must be preserved
5. **Sync Opportunity**: No canonical API-Football data storage (only derived stats cached)

**Output**: [research.md](./research.md) (572 lines)

---

## Phase 1: Design & Contracts

### 1.1 Data Models

#### New Collection: `api_football_raw`

**Purpose**: Store raw API-Football responses as audit trail and canonical source.

**Document Structure**:

```python
# Document ID: "teams" or "fixtures_wc2026"
{
  "entity_type": "teams",  # or "fixtures"
  "league_id": 1,  # World Cup 2026 league ID
  "season": 2026,
  "raw_response": {
    # Complete API-Football JSON response
    "response": [
      {
        "team": {
          "id": 16,
          "name": "Mexico",
          "code": "MEX",
          "country": "Mexico",
          "founded": 1927,
          "logo": "https://..."
        }
      }
    ]
  },
  "fetched_at": "2025-12-27T10:00:00Z",
  "synced_at": "2025-12-27T10:05:00Z",
  "sync_status": "success",  # or "partial", "failed"
  "changes_detected": 5,  # Number of teams/fixtures modified
  "conflicts_resolved": 1,  # Manual overrides preserved
  "metadata": {
    "api_version": "v3",
    "endpoint": "/teams",
    "params": {"league": 1, "season": 2026}
  }
}
```

#### Updated Collection: `teams`

**New Fields** (backward compatible):
```python
{
  # ... existing fields ...
  "api_football_raw_id": "teams",  # Reference to api_football_raw document
  "last_synced_at": "2025-12-27T10:05:00Z",
  "manual_override": false,  # True if manually edited, skip sync updates
  "sync_conflicts": []  # Array of conflict logs
}
```

#### Updated Collection: `matches`

**New Fields** (backward compatible):
```python
{
  # ... existing fields ...
  "api_football_raw_id": "fixtures_wc2026",
  "last_synced_at": "2025-12-27T10:05:00Z",
  "manual_override": false,
  "sync_conflicts": []
}
```

**Output**: Data model documented in this plan + update `backend/docs/data-model.md`

### 1.2 API Contracts

#### New Endpoint: Sync API-Football Data

```python
POST /api/sync-api-football
Content-Type: application/json

Request:
{
  "entity_type": "teams",  # or "fixtures"
  "league_id": 1,  # World Cup 2026
  "season": 2026,
  "force_update": false  # If true, override manual_override flags
}

Response:
{
  "status": "success",
  "entity_type": "teams",
  "changes_detected": 5,
  "conflicts_resolved": 1,
  "entities_added": 2,
  "entities_updated": 3,
  "entities_unchanged": 43,
  "raw_document_id": "teams",
  "synced_at": "2025-12-27T10:05:00Z",
  "details": [
    {
      "entity_id": 16,
      "entity_name": "Mexico",
      "action": "updated",
      "fields_changed": ["name", "logo"],
      "conflict": false
    }
  ]
}
```

#### New Module: `api_football_sync.py`

**Public Interface**:

```python
class APIFootballSync:
    """Syncs API-Football data to Firestore with change detection."""
    
    def __init__(
        self,
        firestore_manager: FirestoreManager,
        data_aggregator: DataAggregator
    ):
        """Initialize with dependencies."""
        
    def sync_teams(
        self,
        league_id: int,
        season: int,
        force_update: bool = False
    ) -> SyncResult:
        """
        Sync teams from API-Football to Firestore.
        
        Process:
        1. Fetch teams from API-Football
        2. Store raw response in api_football_raw collection
        3. Detect changes compared to existing teams collection
        4. Resolve conflicts (manual overrides vs API updates)
        5. Update teams collection
        6. Return sync summary
        """
        
    def sync_fixtures(
        self,
        league_id: int,
        season: int,
        force_update: bool = False
    ) -> SyncResult:
        """
        Sync fixtures from API-Football to Firestore.
        
        Similar process to sync_teams.
        """
        
    def detect_changes(
        self,
        raw_entities: List[Dict],
        existing_entities: List[Dict]
    ) -> ChangeSet:
        """
        Compare raw API data with existing Firestore data.
        
        Returns:
        - entities_to_add: New entities from API
        - entities_to_update: Changed entities
        - entities_unchanged: No changes detected
        - conflicts: Entities with manual_override=True that changed in API
        """
        
    def resolve_conflicts(
        self,
        conflicts: List[Conflict],
        force_update: bool
    ) -> List[Resolution]:
        """
        Resolve conflicts between manual overrides and API updates.
        
        Strategy:
        - If force_update=False: Preserve manual override, log conflict
        - If force_update=True: Apply API update, clear manual_override flag
        """
```

**Output**: Contract defined in this plan

### 1.3 Failing Tests

**TDD Approach**: Write tests FIRST that expect sync behavior.

#### Test 1: Sync Teams from API-Football

**File**: `backend/tests/test_api_football_sync.py`

```python
def test_sync_teams_stores_raw_response():
    """FAILING TEST: Should store raw API-Football response"""
    # Setup
    firestore_manager = Mock()
    data_aggregator = Mock()
    
    # Mock API-Football response
    api_response = {
        "response": [
            {"team": {"id": 16, "name": "Mexico", "code": "MEX"}},
            {"team": {"id": 2384, "name": "USA", "code": "USA"}}
        ]
    }
    data_aggregator.fetch_teams.return_value = api_response
    
    # Create sync module
    sync = APIFootballSync(firestore_manager, data_aggregator)
    
    # Act: Sync teams
    result = sync.sync_teams(league_id=1, season=2026)
    
    # Assert: Raw response stored in api_football_raw collection
    firestore_manager.store_raw_api_response.assert_called_once()
    call_args = firestore_manager.store_raw_api_response.call_args[1]
    assert call_args["entity_type"] == "teams"
    assert call_args["raw_response"] == api_response
    assert "fetched_at" in call_args
```

**Expected Result**: âŒ FAILS - `APIFootballSync` class doesn't exist yet

#### Test 2: Change Detection

```python
def test_detect_changes_identifies_new_teams():
    """FAILING TEST: Should detect new teams from API"""
    sync = APIFootballSync(Mock(), Mock())
    
    # Existing teams in Firestore
    existing = [
        {"id": 16, "name": "Mexico", "fifa_code": "MEX"}
    ]
    
    # Raw API response (includes new team)
    raw_entities = [
        {"team": {"id": 16, "name": "Mexico", "code": "MEX"}},
        {"team": {"id": 2384, "name": "USA", "code": "USA"}}  # NEW
    ]
    
    # Act: Detect changes
    changes = sync.detect_changes(raw_entities, existing)
    
    # Assert: Should detect 1 new team
    assert len(changes.entities_to_add) == 1
    assert changes.entities_to_add[0]["id"] == 2384
    assert len(changes.entities_unchanged) == 1
```

**Expected Result**: âŒ FAILS - `detect_changes()` method doesn't exist

#### Test 3: Conflict Resolution (Manual Override)

```python
def test_resolve_conflicts_preserves_manual_overrides():
    """FAILING TEST: Should preserve manual overrides by default"""
    sync = APIFootballSync(Mock(), Mock())
    
    # Conflict: Team manually edited (manual_override=True)
    conflicts = [
        Conflict(
            entity_id=16,
            entity_name="Mexico",
            firestore_value={"name": "MÃ©xico (Custom)"},
            api_value={"name": "Mexico"},
            field="name",
            manual_override=True
        )
    ]
    
    # Act: Resolve conflicts without force_update
    resolutions = sync.resolve_conflicts(conflicts, force_update=False)
    
    # Assert: Should preserve manual override
    assert resolutions[0].action == "preserve_override"
    assert resolutions[0].conflict_logged == True
```

**Expected Result**: âŒ FAILS - `resolve_conflicts()` method doesn't exist

#### Test 4: Sync Endpoint

**File**: `backend/tests/test_main.py` (update existing file)

```python
def test_sync_api_football_endpoint():
    """FAILING TEST: POST /api/sync-api-football should trigger sync"""
    from fastapi.testclient import TestClient
    from src.main import app
    
    client = TestClient(app)
    
    # Act: Call sync endpoint
    response = client.post(
        "/api/sync-api-football",
        json={"entity_type": "teams", "league_id": 1, "season": 2026}
    )
    
    # Assert: Should return sync result
    assert response.status_code == 200
    data = response.json()
    assert data["status"] == "success"
    assert "changes_detected" in data
    assert "synced_at" in data
```

**Expected Result**: âŒ FAILS - Endpoint doesn't exist yet

#### Test 5: Legacy Cleanup

```python
def test_no_dbmanager_imports_in_codebase():
    """FAILING TEST: Codebase should have no DBManager references"""
    import subprocess
    
    result = subprocess.run(
        ["grep", "-r", "from src.db_manager", "backend/"],
        capture_output=True,
        text=True
    )
    
    assert result.returncode != 0, "DBManager imports still exist!"
```

**Expected Result**: âŒ FAILS - `populate_from_api_football.py:28` imports DBManager

**Output**: 
- `backend/tests/test_api_football_sync.py` (new file with failing tests)
- `backend/tests/test_main.py` (update with sync endpoint test)
- `backend/tests/test_legacy_cleanup.py` (new file for cleanup validation)

---

## Phase 2: Task Planning Approach

The `/tasks` command will generate an ordered task list following this strategy:

### Task Organization

#### Phase 1: Write Failing Tests (TDD Red)
1. Create `test_api_football_sync.py` with sync logic tests
2. Add sync endpoint test to `test_main.py`
3. Create `test_legacy_cleanup.py` with validation tests

#### Phase 2: Extend Firestore Manager (Foundation)
4. Add `store_raw_api_response()` method to `firestore_manager.py`
5. Add `get_raw_api_response()` method
6. Add tests for raw collection operations

#### Phase 3: Implement Sync Module (Core Logic - TDD Green)
7. Create `api_football_sync.py` skeleton
8. Implement `detect_changes()` method (make tests pass)
9. Implement `resolve_conflicts()` method (make tests pass)
10. Implement `sync_teams()` method (make tests pass)
11. Implement `sync_fixtures()` method (make tests pass)

#### Phase 4: Add Sync Endpoint (Integration)
12. Add `POST /api/sync-api-football` endpoint to `main.py`
13. Wire up `APIFootballSync` with dependencies
14. Add error handling and validation

#### Phase 5: Update Existing Tools
15. Update `populate_from_api_football.py` to use new sync module
16. Remove `db_manager` import
17. Add `--sync-teams` and `--sync-fixtures` CLI flags

#### Phase 6: Delete Legacy Code (Cleanup)
18. Delete `migrate_to_firestore.py`
19. Delete or fix `test_norway_integration.py`
20. Remove DBManager comments from `main.py`

#### Phase 7: Documentation Updates
21. Update `backend/docs/data-model.md` (add api_football_raw collection)
22. Update `README.md` (remove SQLite references, add sync instructions)
23. Create `SYNC_PROCESS.md` (document sync workflow)

#### Phase 8: Validation
24. Run full test suite (verify â‰¥80% coverage)
25. Manual sync test (teams and fixtures)
26. Verify conflict resolution workflow
27. Test frontend compatibility (no breaking changes)

### TDD State Machine Compliance

Each implementation task will follow:
```
IDLE â†’ TEST_FAILING â†’ IMPLEMENTING â†’ TEST_PASSING â†’ COMMITTED
```

Tracked in `.bifrost/tdd-state.json` per Bifrost standards.

---

## Complexity Tracking

| Deviation | Justification | Alternative Rejected Because... |
|:----------|:--------------|:--------------------------------|
| New `api_football_raw` collection | Required to preserve audit trail and detect changes | Without raw data, can't detect if API updates occur or track history |
| Conflict resolution logic | Required to preserve manual overrides (e.g., custom team names) | Blindly overwriting manual edits would lose valuable customizations |
| Manual sync endpoint (not automatic) | FR-004 requirement: manual triggers only | Automatic syncing could introduce unexpected data changes |

**No Constitution Violations**: All changes comply with RULES.md requirements. New code is additive (low risk).

---

## Implementation Summary

### Files to Create

1. **backend/src/api_football_sync.py** (~300 lines)
   - `APIFootballSync` class
   - `detect_changes()` method
   - `resolve_conflicts()` method
   - `sync_teams()` and `sync_fixtures()` methods

2. **backend/tests/test_api_football_sync.py** (~200 lines)
   - Sync logic tests (TDD)
   - Change detection tests
   - Conflict resolution tests

3. **backend/tests/test_legacy_cleanup.py** (~50 lines)
   - DBManager import validation
   - Legacy file absence checks

4. **backend/docs/SYNC_PROCESS.md** (~100 lines)
   - Sync workflow documentation
   - Conflict resolution guide
   - Troubleshooting

### Files to Modify

1. **backend/src/firestore_manager.py** (+50 lines)
   - Add `store_raw_api_response()` method
   - Add `get_raw_api_response()` method
   - Add `api_football_raw` collection reference

2. **backend/src/main.py** (+80 lines, -10 lines)
   - Add `POST /api/sync-api-football` endpoint
   - Remove DBManager comments (lines 167, 190, 193)
   - Wire up `APIFootballSync` dependency

3. **backend/populate_from_api_football.py** (+30 lines, -20 lines)
   - Remove `from src.db_manager import DBManager` (line 28)
   - Add sync module usage
   - Add CLI flags for sync operations

4. **backend/tests/test_main.py** (+30 lines)
   - Add sync endpoint test

5. **backend/docs/data-model.md** (+50 lines)
   - Document `api_football_raw` collection
   - Update architecture diagram

6. **backend/README.md** (+20 lines, -10 lines)
   - Remove SQLite setup instructions
   - Add sync process instructions

### Files to Delete

1. **backend/migrate_to_firestore.py** - One-time migration script (no longer needed)
2. **backend/test_norway_integration.py** - Broken import, references deprecated DBManager

---

## New Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API-Football v3 (Source of Truth)                          â”‚
â”‚ - GET /teams?league=1&season=2026                          â”‚
â”‚ - GET /fixtures?league=1&season=2026                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /api/sync-api-football (Manual Trigger)               â”‚
â”‚ - Fetch raw API responses                                   â”‚
â”‚ - Store in api_football_raw collection                      â”‚
â”‚ - Detect changes vs existing data                           â”‚
â”‚ - Resolve conflicts (manual overrides)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Firestore: api_football_raw Collection (Audit Trail)       â”‚
â”‚ - Document: "teams" (raw API response + metadata)          â”‚
â”‚ - Document: "fixtures_wc2026" (raw fixtures + metadata)    â”‚
â”‚ - Timestamped, versioned, traceable                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sync Process (Change Detection & Conflict Resolution)      â”‚
â”‚ - Compare raw API data with teams/matches collections      â”‚
â”‚ - Detect: added, updated, unchanged                         â”‚
â”‚ - Preserve manual_override=True entities                    â”‚
â”‚ - Log conflicts for review                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Firestore: teams & matches Collections (Working Data)      â”‚
â”‚ - Enhanced with sync metadata (last_synced_at, conflicts)  â”‚
â”‚ - Backward compatible with existing schema                  â”‚
â”‚ - Frontend reads from here (no changes needed)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Existing Prediction Pipeline (Unchanged)                   â”‚
â”‚ - Fetch team stats from API-Football                        â”‚
â”‚ - Generate AI predictions with Gemini                       â”‚
â”‚ - Publish to predictions/latest                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Risk Assessment

### High Risk
- None

### Medium Risk
- **Conflict Resolution Complexity**: Deciding when to override manual edits
  - **Mitigation**: Default to preserving manual overrides, require explicit `force_update=True`
- **API-Football Data Quality**: World Cup 2026 fixtures may be incomplete or change
  - **Mitigation**: Store raw responses for audit, easy to re-sync when API improves

### Low Risk
- **New Collection Impact**: Adding `api_football_raw` collection
  - **Mitigation**: Backend-only, no frontend changes, existing data untouched
- **Legacy Code Deletion**: Removing migration scripts
  - **Mitigation**: Scripts already broken, Git history preserves them

---

## Backward Compatibility

### Frontend Compatibility âœ…
- **No Firestore schema changes to teams/matches** (only additive fields)
- Frontend reads from `teams`/`matches` collections (unchanged)
- New `api_football_raw` collection is backend-only
- All existing fields preserved: `match_number`, `home_team_id`, `ai_summary`

### API Compatibility âœ…
- **No changes to existing endpoints**
- `POST /api/update-tournament` and `POST /api/update-predictions` unchanged
- New `POST /api/sync-api-football` endpoint is additive

---

## Testing Strategy

### Unit Tests
- `test_api_football_sync.py`: Sync logic, change detection, conflict resolution
- `test_firestore_manager.py`: Raw collection CRUD operations
- `test_legacy_cleanup.py`: Verify no DBManager imports

### Integration Tests
- Sync endpoint test (end-to-end sync process)
- Conflict resolution workflow test
- Manual override preservation test

### Coverage Target
- **Maintain â‰¥80%** per RULES.md requirement
- Current coverage: ~85% (per TEST_EXECUTION_RESULTS.md)
- Expected post-refactor: ~87% (new sync module with comprehensive tests)

---

## Deployment Checklist

- [ ] All tests passing (pytest)
- [ ] Code coverage â‰¥80%
- [ ] No DBManager imports in codebase
- [ ] Legacy migration scripts deleted
- [ ] `api_football_raw` collection created in Firestore
- [ ] Sync endpoint tested manually (teams and fixtures)
- [ ] Conflict resolution workflow verified
- [ ] Frontend compatibility verified (no schema changes)
- [ ] Documentation updated (data-model.md, README.md, SYNC_PROCESS.md)

---

**End of Plan**
