# Data Model: vmkula-website

**Created**: 2025-12-25  
**Feature**: vmkula-website  
**Purpose**: Comprehensive data model for World Cup 2026 prediction platform

---

## Entity Definitions

### Core Entities

#### Team
Represents a national team in the tournament.

**Source**: SQLite `worldcup2026.db` (teams table)

```python
class Team:
    id: int                 # Primary key from SQLite
    name: str               # "Mexico"
    fifa_code: str          # "MEX" (3-letter code)
    flag_emoji: str         # "ğŸ‡²ğŸ‡½"
    group_letter: str       # "A"-"L" (null for knockout-only teams)
    is_placeholder: bool    # True for TBD playoff teams (e.g., UEFA playoff winner)
```

**Example**:
```json
{
  "id": 1,
  "name": "Mexico",
  "fifa_code": "MEX",
  "flag_emoji": "ğŸ‡²ğŸ‡½",
  "group_letter": "A",
  "is_placeholder": false
}
```

---

#### Match
Represents a fixture in the tournament.

**Source**: SQLite `worldcup2026.db` (matches table)

```python
class Match:
    id: int                     # Primary key from SQLite
    match_number: int           # 1-104 (sequential)
    home_team_id: int | None    # None for TBD knockout matches
    away_team_id: int | None
    city_id: int                # Foreign key to host_cities table
    stage_id: int               # 1=Group, 2=Round32, 3=Round16, etc.
    kickoff_at: str             # ISO8601 timestamp (e.g., "2026-06-12T15:00:00Z")
    label: str                  # "Winner A vs 3rd Place C/D/E" or "Mexico vs Poland"
    home_score: int | None      # Actual score (None if not played yet)
    away_score: int | None
```

**Example (Group Stage)**:
```json
{
  "id": 1,
  "match_number": 1,
  "home_team_id": 1,
  "away_team_id": 2,
  "city_id": 10,
  "stage_id": 1,
  "kickoff_at": "2026-06-12T15:00:00Z",
  "label": "Mexico vs Poland",
  "home_score": null,
  "away_score": null
}
```

**Example (Knockout - TBD)**:
```json
{
  "id": 73,
  "match_number": 73,
  "home_team_id": null,
  "away_team_id": null,
  "city_id": 5,
  "stage_id": 2,
  "kickoff_at": "2026-06-21T15:00:00Z",
  "label": "Winner A vs 3rd Place C/D/E",
  "home_score": null,
  "away_score": null
}
```

---

#### GroupStanding
Calculated standings for a team in group stage.

**Source**: Calculated by `fifa_engine.py` from match results

```python
class GroupStanding:
    team_id: int
    team_name: str
    group: str              # "A"-"L"
    played: int
    won: int
    draw: int
    lost: int
    goals_for: int
    goals_against: int
    goal_difference: int
    points: int             # 3 for win, 1 for draw, 0 for loss
    fair_play_points: int   # CRITICAL: For tiebreaking (negative values)
    rank: int               # 1-4 within group
```

**Fair Play Points Calculation**:
- Yellow card: -1 point
- Second yellow / Indirect red: -3 points
- Direct red card: -4 points

**Example**:
```json
{
  "team_id": 1,
  "team_name": "Mexico",
  "group": "A",
  "played": 3,
  "won": 2,
  "draw": 1,
  "lost": 0,
  "goals_for": 5,
  "goals_against": 1,
  "goal_difference": 4,
  "points": 7,
  "fair_play_points": -2,
  "rank": 1
}
```

---

#### TeamStatistics
Aggregated performance data from API-Football.

**Source**: Calculated by `data_aggregator.py` from API-Football /fixtures endpoint

```python
class TeamStatistics:
    team_id: int
    avg_xg_for: float | None        # Average xG in last 5 matches (None if unavailable)
    avg_xg_against: float | None
    clean_sheets: int               # Count of matches with 0 goals conceded
    form_string: str                # "W-W-D-L-W" (last 5 matches, most recent first)
    data_completeness: float        # 0.0-1.0 (percentage of matches with xG data)
    confidence: str                 # "high", "medium", "low"
    fallback_mode: str | None       # "traditional_form" if no xG data available
```

**Example (Complete Data)**:
```json
{
  "team_id": 1,
  "avg_xg_for": 1.8,
  "avg_xg_against": 0.9,
  "clean_sheets": 3,
  "form_string": "W-W-D-W-L",
  "data_completeness": 1.0,
  "confidence": "high",
  "fallback_mode": null
}
```

**Example (Missing xG Data)**:
```json
{
  "team_id": 2,
  "avg_xg_for": 1.2,
  "avg_xg_against": 1.5,
  "clean_sheets": 1,
  "form_string": "L-D-W-L-D",
  "data_completeness": 0.6,
  "confidence": "medium",
  "fallback_mode": null
}
```

**Example (No xG Data)**:
```json
{
  "team_id": 3,
  "avg_xg_for": null,
  "avg_xg_against": null,
  "clean_sheets": 2,
  "form_string": "W-D-D-L-W",
  "data_completeness": 0.0,
  "confidence": "low",
  "fallback_mode": "traditional_form"
}
```

---

#### Prediction
AI-generated match prediction.

**Source**: Generated by `ai_agent.py` using Gemini AI

```python
class Prediction:
    match_id: int
    predicted_winner: str           # Team name or "Draw"
    win_probability: float          # 0-100 (percentage)
    predicted_home_score: int
    predicted_away_score: int
    reasoning: str                  # AI explanation (1-2 sentences)
    confidence: str                 # "high", "medium", "low" (based on data completeness)
    generated_at: str               # ISO8601 timestamp
```

**Example**:
```json
{
  "match_id": 73,
  "predicted_winner": "Mexico",
  "win_probability": 65,
  "predicted_home_score": 2,
  "predicted_away_score": 1,
  "reasoning": "Mexico's avg xG of 1.8 vs Poland's 1.2 indicates offensive dominance. Mexico's W-W-D form vs Poland's W-L-D suggests momentum advantage.",
  "confidence": "high",
  "generated_at": "2026-06-12T10:00:00Z"
}
```

---

#### TournamentSnapshot
Complete prediction state published to Firestore.

**Source**: Assembled by `firestore_publisher.py` from all calculated data

```python
class TournamentSnapshot:
    updated_at: str                                 # ISO8601 timestamp
    groups: Dict[str, List[GroupStanding]]          # "A": [{team1}, {team2}, ...]
    bracket: List[BracketMatch]                     # Resolved knockout matchups with predictions
    ai_summary: str                                 # Overall tournament narrative (from Gemini)
    favorites: List[str]                            # Top 3-5 teams per AI analysis
    dark_horses: List[str]                          # Surprise contender teams
```

**Example**:
```json
{
  "updated_at": "2026-06-12T10:00:00Z",
  "groups": {
    "A": [
      {
        "team_id": 1,
        "team_name": "Mexico",
        "played": 3,
        "won": 2,
        "draw": 1,
        "lost": 0,
        "goals_for": 5,
        "goals_against": 1,
        "goal_difference": 4,
        "points": 7,
        "fair_play_points": -2,
        "rank": 1
      }
    ]
  },
  "bracket": [
    {
      "match_id": 73,
      "match_number": 73,
      "stage": "Round of 32",
      "home_team": "Mexico",
      "away_team": "Poland",
      "kickoff_at": "2026-06-21T15:00:00Z",
      "venue": "MetLife Stadium, New Jersey",
      "prediction": {
        "predicted_winner": "Mexico",
        "win_probability": 65,
        "predicted_home_score": 2,
        "predicted_away_score": 1,
        "reasoning": "Mexico's avg xG of 1.8 vs Poland's 1.2 indicates offensive dominance.",
        "confidence": "high"
      }
    }
  ],
  "ai_summary": "The tournament setup favors European and South American teams with strong qualifying campaigns. Brazil, France, and Argentina emerge as clear favorites based on recent form and squad depth. Mexico stands out as a dark horse with home advantage.",
  "favorites": ["Brazil", "France", "Argentina"],
  "dark_horses": ["Mexico", "Japan", "Senegal"]
}
```

---

## Data Relationships & Flow

### Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SQLite: worldcup2026.db (READ-ONLY)                        â”‚
â”‚ - teams (48 teams)                                          â”‚
â”‚ - matches (104 fixtures)                                    â”‚
â”‚ - host_cities (16 venues)                                   â”‚
â”‚ - tournament_stages (7 stages)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Python Backend: db_manager.py                               â”‚
â”‚ - Load tournament structure                                 â”‚
â”‚ - Read match schedule                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Python Backend: fifa_engine.py                              â”‚
â”‚ - Calculate GroupStandings (with Fair Play Points)          â”‚
â”‚ - Rank top 8 third-place teams                              â”‚
â”‚ - Resolve Round of 32 matchups                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API-Football v3                     â”‚  â”‚ Python Backend: ai_agent.py      â”‚
â”‚ - GET /fixtures (match results)     â”‚  â”‚ - Build prompts with stats       â”‚
â”‚ - GET /fixtures/statistics (xG)     â”‚  â”‚ - Call Gemini 3.0 Pro            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ - Parse JSON responses           â”‚
                â”‚                        â”‚ - Retry + fallback logic         â”‚
                â–¼                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ Python Backend: data_aggregator.py  â”‚            â”‚
â”‚ - Fetch team stats (with caching)   â”‚            â”‚
â”‚ - Calculate TeamStatistics           â”‚            â”‚
â”‚ - Handle missing xG data             â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
                â”‚                                   â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Python Backend: firestore_publisher.py                      â”‚
â”‚ - Assemble TournamentSnapshot                               â”‚
â”‚ - Publish to Firestore                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Firestore: predictions/latest                               â”‚
â”‚ - Single document with complete snapshot                    â”‚
â”‚ - Updated on-demand or via Cloud Scheduler                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Next.js Frontend: lib/firestore.ts                          â”‚
â”‚ - Fetch predictions/latest document                         â”‚
â”‚ - Display groups, matches, bracket                          â”‚
â”‚ - Trigger backend refresh if stale                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Entity Relationships

### SQLite Schema (worldcup2026.db)

```sql
-- Teams table
CREATE TABLE teams (
    id INTEGER PRIMARY KEY,
    team_name TEXT NOT NULL,
    fifa_code TEXT,
    group_letter TEXT,
    is_placeholder INTEGER DEFAULT 0
);

-- Matches table
CREATE TABLE matches (
    id INTEGER PRIMARY KEY,
    match_number INTEGER NOT NULL,
    home_team_id INTEGER,
    away_team_id INTEGER,
    city_id INTEGER,
    stage_id INTEGER,
    kickoff_at TEXT,
    match_label TEXT,
    FOREIGN KEY(home_team_id) REFERENCES teams(id),
    FOREIGN KEY(away_team_id) REFERENCES teams(id),
    FOREIGN KEY(city_id) REFERENCES host_cities(id),
    FOREIGN KEY(stage_id) REFERENCES tournament_stages(id)
);

-- Host cities table
CREATE TABLE host_cities (
    id INTEGER PRIMARY KEY,
    city_name TEXT NOT NULL,
    country TEXT NOT NULL,
    stadium TEXT,
    region TEXT,
    airport_code TEXT
);

-- Tournament stages table
CREATE TABLE tournament_stages (
    id INTEGER PRIMARY KEY,
    stage_name TEXT NOT NULL,
    stage_order INTEGER
);
```

### Firestore Schema

**Collection**: `predictions`  
**Document**: `latest`  
**Structure**: See TournamentSnapshot entity definition above

---

## Validation Rules

### GroupStanding Validation
- `rank` must be 1-4 within each group
- `points` = (won Ã— 3) + (draw Ã— 1)
- `goal_difference` = goals_for - goals_against
- `fair_play_points` â‰¤ 0 (always negative or zero)

### TeamStatistics Validation
- `data_completeness` must be 0.0-1.0
- `confidence` must be "high", "medium", or "low"
- If `avg_xg_for` is None, `fallback_mode` must be set
- `form_string` must match pattern: /^[WDL](-[WDL]){0,4}$/

### Prediction Validation
- `win_probability` must be 0-100
- `predicted_home_score` and `predicted_away_score` must be â‰¥ 0
- `confidence` must match `TeamStatistics.confidence` if data-driven
- `reasoning` must be non-empty string

---

## Data Constraints

### Performance Constraints
- Firestore document size: Max 1MB (current snapshot ~50-100KB)
- API-Football rate limit: 100 requests/day (free tier) - **cache aggressively**
- Gemini API cost: ~$0.10 per 104 predictions - **retry max 1 time**

### Data Freshness
- Group standings: Recalculate after each match day
- Team statistics: Update once per day (24-hour cache TTL)
- Predictions: Regenerate when standings change or new stats available

---

## Edge Cases

### Missing Data Scenarios

1. **TBD Knockout Matches**:
   - `home_team_id` and `away_team_id` are `null`
   - `label` contains placeholder text (e.g., "Winner A vs 3rd Place C/D/E")
   - Frontend must display placeholder labels gracefully

2. **Missing xG Data**:
   - Some API-Football matches lack `expected_goals` statistics
   - `data_aggregator.py` excludes those matches from average calculation
   - If ALL matches missing xG, set `fallback_mode = "traditional_form"`

3. **Equal Teams on All Tiebreakers**:
   - If points, GD, goals, head-to-head, and fair play are all equal
   - Final tiebreaker: Random seed (documented as "drawing of lots")

4. **API-Football 429 Error**:
   - Exponential backoff: wait 1s, 2s, 4s
   - After 3 retries, use cached data or fail gracefully

5. **Gemini AI Failure**:
   - After 1 retry (max 2 attempts total), use rule-based prediction
   - Rule-based prediction uses xG differential for probability calculation

---

## Firestore Collection Structure (Optimized)

### 1. Public Read (Hot Data)
* **Collection:** `predictions`
* **Document:** `latest`
* **Content:** Contains the full `groups` and `bracket` tree with ONLY the *current* prediction. (Fast load time).

### 2. Analysis History (Cold Data)
* **Collection:** `matches`
* **Document:** `{match_id}` (e.g., `match_64`)
* **Sub-collection:** `history`
* **Document:** `{timestamp}` (e.g., `2026-06-15_2300`)
* **Content:**
    ```json
    {
      "timestamp": "2026-06-15T23:00:00Z",
      "predicted_winner": "Mexico",
      "confidence": 65,
      "reasoning": "Mexico's home advantage...",
      "trigger_event": "Daily Update" // or "Lineup Change"
    }
    ```

**Benefits:**
- **Performance**: Main document stays under 1MB Firestore limit
- **Cost Optimization**: History data loaded only when needed (analysis view)
- **Scalability**: Unlimited prediction history per match without bloating main document

---

**End of Data Model**
